<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Lost & Found</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="website icon" type="png" href="./Logo2.png" />
    <script type="module" src="profile.js"></script>
  </head>

  <body>
    <div id="tsparticles"></div>
    <header class="navbar">
      <a href="index.html">
        <div class="brand"><img src="./Logo1.png" alt="" /></div>
      </a>
      <div class="nav-right">
        <button class="btn btn-browse" onclick="location.href='index.html'">
          Home
        </button>
        <button
          class="btn btn-browse"
          onclick="location.href='report-lost.html'"
        >
          Report Lost/Found
        </button>
        <!-- <button class="btn btn-browse" onclick="location.href='report-found.html'">Report Found</button> -->
        <button class="btn btn-browse" onclick="location.href='list.html'">
          Browse
        </button>
        <button
          class="btn btn-browse"
          id="login-btn"
          onclick="location.href='login.html'"
        >
          Login/Register
        </button>
      </div>
      <div class="profile-container">
        <div class="username-display" id="headerUsername"></div>
        <img
          src="./Profile.jpg"
          alt="Profile"
          class="profile-img"
          id="profileImg"
        />
        <div class="profile-dropdown" id="profileDropdown">
          <div
            class="dropdown-username"
            id="username"
            onclick="location.href='profile.html'"
          >
            Loading...
          </div>
          <div class="dropdown-divider"></div>
          <div class="dropdown-item" id="resetPasswordBtn">Reset Password</div>
          <div class="dropdown-divider"></div>
          <div class="dropdown-item" id="signoutBtn">Sign In</div>
        </div>
      </div>
    </header>
    <div class="container">
      <h2 id="form-title">Report Item</h2>
      <form id="lostForm">
        <label>Item Name</label>
        <input type="text" placeholder="e.g., Phone" id="itemName" required />
        <label>Description</label>
        <textarea
          rows="3"
          placeholder="Describe the lost item"
          id="description"
          required
        ></textarea>
        <label>Last known location</label>
        <input
          type="text"
          placeholder="Where did you lose it?"
          id="location"
          required
        />
        <p>
          (To get location url ,
          <a href=" https://www.google.co.in/maps" target="_blank">click here</a
          >)
        </p>
        <label>Category</label>
        <div id="categories">
          <input
            type="radio"
            id="electronics"
            name="category"
            value="Electronics"
            required
          />
          <label for="electronics">Electronics</label><br />
          <input
            type="radio"
            id="valuables"
            name="category"
            value="Valuables"
            required
          />
          <label for="valuables">Valuables</label><br />
          <input
            type="radio"
            id="animals"
            name="category"
            value="Animals"
            required
          />
          <label for="animals">Animals</label><br />
          <input
            type="radio"
            id="other"
            name="category"
            value="Other"
            required
          />
          <label for="other">Other</label>
        </div>
        <label>Status</label>
        <div id="status">
          <input type="radio" id="lost" name="status" value="Lost" required />
          <label for="lost">Lost</label><br />
          <input type="radio" id="found" name="status" value="Found" required />
          <label for="found">Found</label><br />
        </div>
        <label>Contact</label>
        <input type="email" placeholder="Your email" id="contact" required />
        <label>Upload image</label>
        <input type="url" placeholder="Image URL only" id="image" required />
        <p>
          (To get an image url ,
          <a href="https://tikolu.net/i/" target="_blank">click here</a>)
        </p>
        <button type="submit" class="btn btn-lost" id="submitBtn">
          Submit Report
        </button>
      </form>
      <!-- Loading and success messages -->
      <div
        id="message"
        style="
          margin-top: 20px;
          padding: 10px;
          border-radius: 5px;
          display: none;
        "
      ></div>
    </div>
    <!-- Particles -->
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        tsParticles.load("tsparticles", {
          background: { color: "#0d0d2b" },
          fpsLimit: 60,
          particles: {
            number: { value: 80 },
            color: { value: ["#ffffff", "#FFA726", "#009688"] },
            links: {
              enable: true,
              distance: 140,
              color: "#fff",
              opacity: 0.25,
            },
            move: { enable: true, speed: 1 },
            size: { value: { min: 2, max: 4 } },
            opacity: { value: 0.6 },
          },
          interactivity: {
            events: { onHover: { enable: true, mode: "repulse" } },
          },
          detectRetina: true,
        });
      });
    </script>
    <!-- Firebase Integration -->
    <script type="module">
      import {
        getCurrentUser,
        addLostItem,
        getLostItemById,
		updateLostItem,
      } from "./firebase.js";

      const lostForm = document.getElementById("lostForm");
      const messageDiv = document.getElementById("message");
      const submitBtn = document.getElementById("submitBtn");
      let editingPostId = null;

      // Function to show messages
      function showMessage(text, type = "info") {
        messageDiv.textContent = text;
        messageDiv.style.display = "block";
        messageDiv.style.backgroundColor =
          type === "success"
            ? "#d4edda"
            : type === "error"
            ? "#f8d7da"
            : "#d1ecf1";
        messageDiv.style.color =
          type === "success"
            ? "#155724"
            : type === "error"
            ? "#721c24"
            : "#0c5460";
        messageDiv.style.border = `1px solid ${
          type === "success"
            ? "#c3e6cb"
            : type === "error"
            ? "#f5c6cb"
            : "#bee5eb"
        }`;
      }

      // Function to check login status
      async function checkLogin() {
        try {
          const user = await getCurrentUser();
          return user !== null;
        } catch (error) {
          console.error("Error checking login status:", error);
          return false;
        }
      }

      // Function to get selected category
      function getSelectedCategory() {
        const categoryInputs = document.querySelectorAll(
          'input[name="category"]'
        );
        for (const input of categoryInputs) {
          if (input.checked) {
            return input.value;
          }
        }
        return null;
      }

      // Function to get selected status
      function getSelectedStatus() {
        const statusInputs = document.querySelectorAll('input[name="status"]');
        for (const input of statusInputs) {
          if (input.checked) {
            return input.value;
          }
        }
        return null;
      }

      // Form submission handler
      lostForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Check if user is logged in
        const isLoggedIn = await checkLogin();
        if (!isLoggedIn) {
          alert("You must login before submitting a report.");
          window.location.href = "login.html";
          return;
        }

        // Disable submit button and show loading
        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";
        showMessage("Submitting your lost item report...", "info");

        try {
          // Get form data
          const itemName = document.getElementById("itemName").value.trim();
          const description = document
            .getElementById("description")
            .value.trim();
          const location = document.getElementById("location").value.trim();
          const category = getSelectedCategory();
          const status = getSelectedStatus();
          const contact = document.getElementById("contact").value.trim();
          const image = document.getElementById("image").value.trim();

          // Validate required fields
          if (
            !itemName ||
            !description ||
            !location ||
            !category ||
            !status ||
            !contact ||
            !image
          ) {
            showMessage("Please fill in all required fields.", "error");
            return;
          }

          // Validate email format
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(contact)) {
            showMessage("Please enter a valid email address.", "error");
            return;
          }

          // Validate URL format
          const urlRegex = /^https?:\/\/.+/;
          if (!urlRegex.test(image)) {
            showMessage(
              "Please enter a valid image URL (starting with http:// or https://).",
              "error"
            );
            return;
          }

          // Prepare data for Firebase
          const lostItemData = {
            itemName,
            description,
            location,
            category,
            status,
            contact,
            image,
          };

          let result;
          if (editingPostId) {
            // Update existing post
            result = await updateLostItem(editingPostId, lostItemData);
          } else {
            // Submit new post
            result = await addLostItem(lostItemData);
          }

          if (result.success) {
            showMessage(
              "Lost item report submitted successfully! Your report ID is: " +
                result.id,
              "success"
            );

            // Reset form after successful submission
            lostForm.reset();

            // Redirect to browse page after a delay
            setTimeout(() => {
              window.location.href = "list.html";
            }, 3000);
          } else {
            showMessage("Error submitting report: " + result.error, "error");
          }
        } catch (error) {
          console.error("Submission error:", error);
          showMessage(
            "An unexpected error occurred. Please try again.",
            "error"
          );
        } finally {
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Lost Report";
        }
      });

      document.addEventListener("DOMContentLoaded", async () => {
        const submitBtn = document.getElementById("submitBtn");
        const h2 = document.getElementById("form-title");
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has("edit")) {
          editingPostId = urlParams.get("edit");
          // Fetch existing post data
          const result = await getLostItemById(editingPostId);
          if (result.success) {
            const item = result.data;
            document.getElementById("itemName").value = item.itemName || "";
            document.getElementById("description").value =
              item.description || "";
            document.getElementById("location").value = item.location || "";
            document.getElementById("contact").value = item.contact || "";
            document.getElementById("image").value = item.image || "";
            // Set category radio
            if (item.category) {
              document.querySelector(
                `input[name="category"][value="${item.category}"]`
              ).checked = true;
            }
            // Set status radio
            if (item.status) {
              document.querySelector(
                `input[name="status"][value="${item.status}"]`
              ).checked = true;
            }
            // Update form title/button
            if (h2) h2.textContent = "Edit Lost Item";	
            if (submitBtn) submitBtn.textContent = "Update Report";
          }
        }
      });
    </script>
  </body>
</html>
